# Gmail 의 이메일 발신자 가이드라인 강화가 가져온 변화

ref. https://qiita.com/hirachan/items/f668511783c6e0663cb2
ref. https://support.google.com/a/answer/81126?hl=ko

## 시작하며

Gmail의 이메일 발신자 가이드라인이 강화된지 2주 이상 지났습니다. 여러분 어떻게 지내고 계시는지요.
이번 건, 여러 가지 생각할 일이 많으시겠지만 Google이 왜 이런 정책을 취했는지 그리고 가까운 장래 또는 먼 미래에 이메일 보안은 어떻게 될 것인지 생각해 보려고 합니다.

## 현 상황의 정리
### 스팸 메일의 재정의

스팸 메일이라 해도 사람마다 그 정의는 다를지도 모릅니다. 이번 조치로 Google 은 그 정의를 보다 명확하게 표명했습니다.

예를 들면 "발신자를 사칭하는 메일". 최근에는 아마존이나 신용카드 회사를 사칭하는 발신자 사칭 메일이 많습니다. 
이러한 메일은 100% 스팸 메일이라고 판단해 수신할 필요는 없을 것입니다.

그렇다면 어느 쇼핑몰 사이트로부터의 메일은 어떨까요. 예를 들면 취미로 장난감을 살 떄 등록한 점포로부터 매월 신제품 정보가 옵니다. 
A씨는 매일 즐거운 마음으로 신제품 리뷰를 즐기고 있습니다. 
그러나 B씨는 처음에는 즐거웠지만 최근에는 관심이 사라져 솔직히 매일 오는 메일이 귀찮게 느껴지고 있습니다.
B씨는 이 점포의 메일을 스팸메일로 보고해 수신함에 도착하지 않도록 했습니다.
이러한 광고 메일의 경우, 사람마다 읽고 싶은 메일일 수도 있고 스팸 메일일 수도 있는 등 판단이 달라집니다.

이번 Google의 조치는 심플합니다.
- 발신자 사칭 가능성이 있는 메일은 스팸 메일이다.
- 광고 메일은 스팸메일로 보고 가 아니라 구독해제할 수 있도록 하여, 원하는 사람만이 수신하면 된다.
- 구독해제 기능이 없고 0.3% 이상 스팸메일로 보고되는 발신자로부터의 메일은 스팸 메일로 판단한다.

이처럼 지금까지 막연했던 스팸 메일의 정의가 어느 정도 확실해졌습니다.

### 발신자 사칭이 아님을 증명
발신자 사칭이 아닌 진짜 발신자임을 판단하는 것에는 다음 정보가 사용됩니다.

##### 발신IP의 역방향 호스트명의 정당성
발신 IP 주소를 역방향으로 조회해, 그 결과를 정방향으로 조회하고 그 중 원래 IP 주소가 있는지 없는지 확인합니다. 멋있게 말하자면 FCrDNS 라고 합니다. 메일에 대해 아는 사람들은 20년 전부터 알고 있는 그것입니다.

192.0.2.1 --> mx.example.jp --> 192.0.2.1
와 같은 확인입니다.

정방향 DNS 레코드는 이 경우 example.jp의 소유자만이 쓸 수 있기 때문에 mx.example.jp가 올바른 역방향 호스트명이라는 것을 알 수 있습니다. 정방향까지 검증하지 않으면 역방향 만으로는 누구의 도메인이든 사칭할 수 있게 됩니다.

출구가 분산되어 복수인 경우에도 각각 호스트명을 가지지 않으면 안된다든가 하는 이야기도 종종 듣습니다만, 
복수의 IP가 같은 호스트명을 돌려주거나 하나의 호스트명이 복수의 IP주소를 돌려주어도 문제없습니다.

#### HELO 도메인의 정당성
이것은 SPF로 확인할 수 있습니다.
MAIL FROM이 <>인 경우에 이것이 사용됩니다만 종종 쓰는 것을 잊은 듯한 환경들이 있습니다.
Gmail이 이것을 사용하는지는 불분명합니다.

#### MAIL FROM 도메인의 정당성
이것도 SPF로 확인할 수 있습니다.

#### HEADER FROM 도메인의 정당성
이것은 DKIM으로 확인할 수 있습니다.
또한, Header From 도메인은 SPF 도메인이나 DKIM 서명자 중 하나와 일치해야 할 필요가 있습니다.
추천은 SPF, DKIM 양쪽 모두 Header From 도메인과 일치하는 것입니다.

* 본래 SPF의 MAIL FROM 도메인이나 DKIM의 서명자는 Header From과 일치할 필요가 없습니다.
  이것은 DMARC 의 요건입니다.
  DMARC는 p=none이어도 좋다고 말하고 있으나 실제로는 p=quarantine 또는 reject 에 해당한다고 할 수 있습니다.

  
